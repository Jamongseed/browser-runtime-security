[기본 정보]
메인(정상 사이트): http://localhost:3000/
서드파티 서버: http://localhost:4000/

<주의!!!>: http만 사용하시고 localhost만 사용해주세요. https를 사용하거나 127.0.0.1을 사용하시면 작동이 안됩니다!

[동작순서]
1. http://localhost:3000/ 접속
2. 오른쪽 아래에 광고 위젯(iframe) 이 자동으로 뜸
3. 위젯 안의 “광고 보기(클릭)” 버튼을 누르면 → iframe이 부모창에 postMessage를 보냄
4. 그 신호를 받은 서드파티 SDK(부모창에 로드된 script) 가 armed=true가 됨
5. 이제 로그인 폼 submit 시, submit 캡처 단계에서 form.action을 http://localhost:4000/collect로 바꿔치기
6. 결과적으로 제출이 :3000/login이 아니라 :4000/collect로 감
*물론 광고를 건들지 않는다면 정상적으로 로그인이 됩니다.*


[이런 상황을 만든 이유?]
1. iframe을 숨긴 버젼은 poc-a-login에 구현 된적 있음.
2. 마찬가지로 가짜 로그인 사이트에서 아이디 비번 수집도 구현은 poc-a-login에 구현 되어있음
//여기까지의 상황은 이미 로그인 사이트 자체가 가짜 페이지라서 유저의 잘못으로 이미 잘못된 곳에 와있는거임


//하지만 여기서 구현한 상황은 나름대로(?) 멀쩡한 사이트인데, 광고를 넣는 서드파티 스크립트 쪽에서 개수작은 부린 케이스임.
예를 들면, PoC를 할 생각은 없던 불법웹툰사이트가 있고, 당연히 광고수익으로 돈을 벌어야하니 운영자 측에서 서드파티를 허용함.
그런데 광고쪽(주로 토토 이런놈들)에서 신뢰를 깨버리고 갑자기 이상한 스크립트를 넣어버림.
원래 페이지를 운영하던 불법웹툰사이트의 서버도 사실 피해자(?) 느낌이지만,

유저 입장에서는 1년동안 잘 이용하던 불법사이트지만, 실수로든 닫기버튼을 누르려다 잘못 터치했든, 어느날 광고를 클릭했다가 로그인을 했더니 그 정보가 수집을 당한 경우입니다.
누누TV나 NBA같은 스포츠 불법 사이트에서 로그인을 구현한 경우가 은근히 있어서 생각보다 그럴싸한 시나리오라고 생각하고 구현했습니다.


P.S 더욱 악질인거는 iframe이 로드 되자마자 자동으로 postMessage를 보내는 방식도 있긴 한데, 뭔가 트리거를 구현하고 싶어서 이렇게 설정했습니다. PR에서 수정사항 같은걸 넣어주시면 그때 또 반영하겠습니다.

그리고 SDK 자체가 장르로 부류하기에 좋은 소재인것 같습니다. 이 경우에는 iframe이 무난한 트리거 역할이었고,
그냥 SDK자체에서 조건을 시간,UA,랜덤,쿠키 같은걸 만족하면 submit 같은거를 후킹을 해버리도록 여러 트리거를 만드는게 가능하겠더라구요.
확장프로그램의 rule이나 schema에서 따로 분류를 하면 뭔가 비슷하게 더 구현해도 될 것 같습니다. 기능적인 면에서 중복이면 굳이 더 안만들어도 되구요.


[확장프로그램에서 탐지할 요소들?]
1. <script src="http://localhost:4000/sdk.js"> 처럼 현재 페이지 origin과 다른 origin의 JS 실행
2. DOM에 <iframe src="http://localhost:4000/widget.html"> 생성
3. window.addEventListener("message", ...) 같은 부모페이지 제어 신호, message이벤트 발생 시점 같은거 탐지 가능
4. [form.action 값이 submit 직전에 변경, 변경 전/후 origin 비교] 탐지가능
솔직히 일반 광고에도 쓰이는 요소들은 함부로 피싱이라고 단정 지을 수는 없는데, 여러 상황의 교집합이라면 PoC라고 할 수 있을 것 같습니다. rule에서 좀 더 다뤄봐야 하겠네요. 일단 4번은 좀 빼박이긴 합니다.

+사실 제가 원하는 탐지 시점은 광고를 클릭한 시점에 action의 목적지를 바꾸도록 예약이 걸리는데 확장프로그램에서 탐지가 가능한지 궁금합니다. 단순히 form.action값을 변경해놓는거는 poc-a-login에 구현되어있고,
심지어 페이지 시작부터 정해져있어서 더욱 확실한 PoC는 a 모델이긴 합니다. 다만 a 모델이 이제 로그인 양식을 제출 했을때 수상한 움직임을 포착하는데에 의의를 둔다면, 이친구는 서드파티가 개수작을 시작한 시점을 
확장프로그램이 감지가 가능한지를 확인하는 용도로 제작되었습니다.