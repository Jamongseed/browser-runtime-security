 <!doctype html>
 <html lang="ko">
 <head>
   <meta charset="utf-8" />
   <meta name="viewport" content="width=device-width,initial-scale=1" />
   <title>PoC-h: Script injection</title>
   <link rel="stylesheet" href="/style.css" />
 </head>
 <body>
     <main class="card">
        <h1>PoC-H: Script Injection (2-stage loader)</h1>
         <p class="desc">
             우측하단 광고 위젯의 <b>닫기</b>를 누르면(서드파티 SDK가 위젯 DOM을 제거),
             메인 페이지가 <code>MutationObserver</code>로 이를 감지하고
            <code>http://localhost:4000/loader.js</code>를 동적으로 삽입합니다.<br />
            로더는 <code>payload.b64</code>를 가져와 <code>atob</code>로 디코딩한 뒤 2차 페이로드를 실행합니다.
         </p>

         <div class="status" id="status">Ready. (waiting for ad close)</div>

             <div style="margin-top: 20px;">
                 <input type="text" id="test-input" placeholder="여기에 아무거나 타이핑 해보세요!"
                        style="width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px;">
                 <p style="font-size: 12px; color: #666; margin-top: 8px;">
                    ※ 위젯을 닫은 후 여기서 타이핑하면 5000번 서버로 전송됩니다. (기존 텔레메트리 데모)
                 </p>
             </div>

         <details class="hint">
             <summary>PoC 체인</summary>
             <ol>
                 <li>Third-party SDK(:4000)가 광고 위젯을 삽입</li>
                 <li>사용자: 닫기 클릭</li>
                 <li>Main(:3000): MutationObserver로 위젯 DOM 제거 감지</li>
                <li>Main(:3000): loader.js를 동적 삽입(1차 로더)</li>
                <li>Loader(:4000): payload.b64 fetch → atob 디코드 → 2차 페이로드 실행</li>
                <li>Payload: XMLHttpRequest.prototype(open/send) 후킹</li>
                <li>사용자: Test XHR 클릭 → /health 요청 발생</li>
                <li>Payload: 요청 메타를 :4000/mirror로 미러링(서버 로그로 확인)</li>
             </ol>
         </details>

         <div style="margin-top: 16px;">
             <button id="btn-xhr"
                     style="padding: 10px 14px; border: 1px solid #ccc; border-radius: 8px; background: #fff; cursor: pointer;">
                 Test XHR 요청 보내기
             </button>
             <p style="font-size: 12px; color: #666; margin-top: 8px;">
                 ※ 위젯을 닫은 뒤 이 버튼을 누르면 XHR이 발생합니다. (후킹/미러링 확인용)
             </p>
         </div>

        <div style="margin-top: 10px;">
            <button id="btn-remove"
                    style="padding: 10px 14px; border: 1px solid #ccc; border-radius: 8px; background: #fff; cursor: pointer;">
                Injected 제거(방어자)
            </button>
            <p style="font-size: 12px; color: #666; margin-top: 8px;">
                ※ stage2 스크립트(#pocH_stage2)를 제거합니다. 이후 자동 재주입이 발생하면 persistence 증거입니다.
            </p>
        </div>
     </main>

   <script src="/gate.js"></script>
   <script src="http://localhost:4000/sdk.js"></script>
   <script>
     document.addEventListener("DOMContentLoaded", () => {
       const btn = document.getElementById("btn-xhr");
       if (!btn) return;

       btn.addEventListener("click", () => {
         const xhr = new XMLHttpRequest();
         xhr.open("GET", "/health?ts=" + Date.now());
         xhr.onload = () => console.log("[poc-h] XHR ok:", xhr.status);
         xhr.onerror = () => console.log("[poc-h] XHR error");
         xhr.send();
       });

      const rm = document.getElementById("btn-remove");
      if (!rm) return;
      rm.addEventListener("click", () => {
        const s2 = document.getElementById("pocH_stage2");
        if (s2) {
          s2.remove();
          console.log("[poc-h] stage2 removed by defender");
        } else {
          console.log("[poc-h] stage2 not found");
        }
      });
     });
   </script>
 </body>
 </html>
